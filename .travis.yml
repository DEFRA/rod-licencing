os: linux
dist: bionic
language: node_js
node_js:
  - '14'
cache: npm

git:
  depth: false
  quiet: true

env:
  global:
    # Allow proper date/time handling in unit tests
    - TZ=Europe/London

# Don't execute when the commit was a release chore generated by the deploy phase of this job
if: commit_message !~ /^chore\(release\)/ OR (type = pull_request and branch = master)

branches:
  only:
    - master
    - develop

before_install:
  - printenv

script:
  - echo "Starting tests at $(date)"
  - npm test
  - echo "Tests completed at $(date)"
  - sonar-scanner
  - echo "Sonar analysis completed at $(date)"

before_deploy:
  # Configure git
  - git config --global user.email ${GITHUB_EMAIL}
  - git config --global user.name ${GITHUB_USER}
  - git remote set-url origin "https://${GITHUB_AUTH}@github.com/DEFRA/rod-licensing.git" > /dev/null 2>&1
  # Configure npm
  - echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" >> $HOME/.npmrc 2> /dev/null

deploy:
  - provider: script
    script: bash scripts/travis/deploy.sh
    skip_cleanup: true
    on:
      branch: develop
  - provider: script
    script: bash scripts/travis/deploy.sh
    skip_cleanup: true
    on:
      branch: master

addons:
  sonarcloud:
    organization: 'defra'
    token:
      secure: UBZIVe16QVFTpftwVjI48vtUHrdaHQ00ue59EOpvmvlluJeQFsy7SUqKAiFT0eI1YwfSbDu7NAP/WGtRXztcczo6Aa6rYRcPH1CBNpsQu9b3cuivhapXTa7vixF0/kef7XGeMaHxLLamIj04QPvNdGw4PeSx9W6pbgeBue5Orqgaj7RdWuJ/7HayzeelXKMG70fh5J+MiWPosekbLDu7e4OHhOOOwZ7KwcRRG+JJQZvMadIbqUn1TCyvTLdLaWpw38PzlpfUCol3d9EIX+BgIvA2W8te1M8o1XBUDmo48+X5Rf3yDyh10jLiAjJrWTTFUx6/WR5Z3wiLVbyR09amKg5mZ7sXJzgcKiARdHGAKQZ9GVhYo0iJIL0DPrLJnXXCSLPBe7C2C3hCqgFLFZHfspdrQ8pLlX4w/vigb4j4ZzxvIbka1FJOSnaupj5UxKnoTx2BnNgE7ik3Jn/suFBIB+T7hDLEmU+/6/8y0n31gVbW1DiAimVI9IeDuGj80+0fVDfelirkD5b8tpPkiBlTfM1Y67rM6OK2DlqUB8Y/SrzrSHS1I8KrIVvh0zNCo7XE6ZoK7BwO4v56Gj/2yMslr6S9X4JZxjTNk7bhSqPdUuaTUrPU9GHtU1EGzPurW+OolnpaeEBJqAsJZyQccLn9Sw1r69ise0iuZr0k6RzOQyw=
