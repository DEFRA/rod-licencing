{% extends "standard-form.njk" %}
{% from "radios/macro.njk" import govukRadios %}
{% from "input/macro.njk" import govukInput %}
{% from "warning-text/macro.njk" import govukWarningText %}

{% set title = 'What is your preferred way of being contacted?' if data.isPhysical else 'How would you like to receive your licence details?' %}

{% set errorMap = {
        'how-contacted': {
            'any.required': { ref: '#how-contacted', text: errorMsg }
        },
        'email': {
            'string.empty': { ref: '#email', text: 'You did not enter your email address' },
            'string.email': { ref: '#email', text: 'You did not enter a valid email address' },
            'string.max': { ref: '#email', text: 'You did not enter a valid email address' }
        },
        'text': {
            'string.empty': { ref: '#email', text: 'You did not enter your mobile phone number' },
            'string.pattern.base': { ref: '#email', text: 'You did not enter a valid mobile phone number' },
            'string.max': { ref: '#email', text: 'You did not enter a valid mobile phone number' }
        }
    }
%}

{% block pageTitle %}{{ title }} - GOV.UK{% endblock %}

{% set emailHtml %}
    <div id="email-rw" class="govuk-body-m">
        {{ govukInput({
          id: "email",
          name: "email",
          type: "text",
          classes: "govuk-!-width-two-thirds",
          autocomplete: "email",
          errorMessage: { text: 'Enter your email address' } if error['email'],
          label: {
            text: "Email address"
          },
          hint: {
              text: "For example angling@email.com"
          },
          attributes: {
            spellcheck: "false",
            maxlength: "50"
          },
          value: payload.email if payload['how-contacted'] === 'email' else ''
        }) }}
    </div>
    <div id="email-ro" class="govuk-body-m initially-hidden">
        Email address</br>
        <span class="govuk-body-m govuk-!-font-weight-bold">{{ data.licensee.email }}
            &nbsp;&nbsp;<a id="change-email" href="#" class="govuk-link">Change</a>
        </span>
    </div>
{% endset -%}

{% set textMessageHtml %}
    <div id="text-rw" class="govuk-body-m">
        {{ govukInput({
          id: "text",
          name: "text",
          type: "tel",
          autocomplete: "tel",
          classes: "govuk-!-width-two-thirds",
          errorMessage: { text: "Enter your mobile phone number. For overseas numbers include '+' followed by your country code" } if error['text'],
          label: {
            text: "Mobile phone number"
          },
          hint: {
              text: "For example 07700 900 900"
          },
          attributes: {
            maxlength: "30"
          },
          value: payload.text if payload['how-contacted'] === 'text' else ''
        }) }}
     </div>
     <div id="text-ro" class="govuk-body-m initially-hidden">
         Mobile phone number</br>
         <span class="govuk-body-m govuk-!-font-weight-bold">{{ data.licensee.mobilePhone }}
             &nbsp;&nbsp;<a id="change-text" href="#" class="govuk-link">Change</a>
         </span>
     </div>
{% endset -%}

{% set noneHtml %}
    {{ govukWarningText({
      text: "Make a record of your licence number after payment",
      iconFallbackText: "Warning",
      classes: "govuk-!-margin-top-3"
    }) }}
    <p class="govuk-body-m">When you go fishing you must be able to show it to our enforcement officers if asked.</p>
{% endset -%}

{% block pageContent %}
    <p class="govuk-body-m">We will normally only send you messages that are key to the service such as payment confirmation, licence details and renewal reminders.</p>

    {{ govukRadios({
      idPrefix: "how-contacted",
      name: "how-contacted",
      errorMessage: { text: 'Select how you would like to receive your licence details' } if error['how-contacted'],
      fieldset: {
        legend: {
          text: selectText,
          isPageHeading: false,
          classes: "govuk-body-m"
        }
      },
      items: [
        {
          value: "email",
          text: "Email",
          checked: payload['how-contacted'] === 'email',
          conditional: {
            html: emailHtml
          }
        },
        {
          value: "text",
          text: "Text message",
          checked: payload['how-contacted'] === 'text',
          conditional: {
            html: textMessageHtml
          }
        },
        {
          value: "none",
          text: "Post" if data.isPhysical else "I don't have email or a mobile phone",
          checked: payload['how-contacted'] === 'none',
          conditional: {
            html: postHtml if data.isPhysical
          }
        }
      ]
    }) }}

{% endblock %}

{% block bodyEnd %}
    <script nonce={{nonce}} src="/public/javascript/all-min.js"></script>
    <script nonce={{nonce}}>window.GOVUKFrontend.initAll()</script>
    <script nonce={{nonce}}>(function () {
        if ('{{ data.licensee.preferredMethodOfConfirmation }}' === '{{data.howContacted.email}}') {
            document.getElementById("email-ro").style.display = "block"
            document.getElementById("email-rw").style.display = "none"
        } else {
            document.getElementById("email-ro").style.display = "none"
            document.getElementById("email-rw").style.display = "block"
        }
        document.getElementById("change-email").addEventListener("click", function () {
            document.getElementById("email-ro").style.display = "none"
            document.getElementById("email-rw").style.display = "block"
        })
    })()</script>
        <script nonce={{nonce}}>(function () {
            if ('{{ data.licensee.preferredMethodOfConfirmation }}' === '{{data.howContacted.text}}') {
                document.getElementById("text-ro").style.display = "block"
                document.getElementById("text-rw").style.display = "none"
            } else {
                document.getElementById("text-ro").style.display = "none"
                document.getElementById("text-rw").style.display = "block"
            }
            document.getElementById("change-text").addEventListener("click", function () {
                document.getElementById("text-ro").style.display = "none"
                document.getElementById("text-rw").style.display = "block"
            })
        })()</script>
{% endblock %}